---
- name: Setup a Docker registry
  hosts: docker-registry
  sudo: True
  tasks:
    - name: Starting the Docker registry
      docker:
        image: registry:2
        name: registry
        state: started
        restart_policy: always
        detach: true
        ports:
          - '4000:5000'

- name: Setup all nodes to use the new Docker registry
  hosts: hosts
  sudo: True
  tasks:
    - name: Allow Docker to run with an insecure registry
      lineinfile: >
        dest=/etc/default/docker
        line='DOCKER_OPTS="--insecure-registry 192.168.1.100:4000"'

    - name: Restart Docker services
      service: name=docker state=restarted
